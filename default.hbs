<!DOCTYPE html>
<html lang="{{@site.locale}}">
<head>

    {{!-- Basic meta - advanced meta is output with {{ghost_head}} below --}}
    <title>{{meta_title}}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {{!-- Preload main styles and scripts for better performance --}}
    <link rel="preload" as="style" href="{{asset "built/screen.css"}}">
    <link rel="preload" as="script" href="{{asset "built/source.js"}}">

    {{!-- Theme assets - use the {{asset}} helper to reference styles & scripts, this will take care of caching and cache-busting automatically --}}
    <link rel="stylesheet" type="text/css" href="{{asset "built/screen.css"}}">
    <link rel="stylesheet" type="text/css" href="{{asset "css/custom-portal.css"}}">
    <link rel="stylesheet" type="text/css" href="{{asset "css/signup-form.css"}}">

    <link rel="preconnect" href="https://fonts.googleapis.cot">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Work+Sans:ital,wght@0,100..900;1,100..900&family=Zen+Kaku+Gothic+New&display=swap" rel="stylesheet">

    {{!-- Custom background color --}}
    <style>
        :root {
            --background-color: {{@custom.site_background_color}}
        }
    </style>

    <script>
        /* The script for calculating the color contrast has been taken from
        https://gomakethings.com/dynamically-changing-the-text-color-based-on-background-color-contrast-with-vanilla-js/ */
        var accentColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color');
        accentColor = accentColor.trim().slice(1);

        if (accentColor.length === 3) {
            accentColor = accentColor[0] + accentColor[0] + accentColor[1] + accentColor[1] + accentColor[2] + accentColor[2];
        }

        var r = parseInt(accentColor.substr(0, 2), 16);
        var g = parseInt(accentColor.substr(2, 2), 16);
        var b = parseInt(accentColor.substr(4, 2), 16);
        var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        var textColor = (yiq >= 128) ? 'dark' : 'light';

        document.documentElement.className = `has-${textColor}-text`;
    </script>

    {{!-- This tag outputs all your advanced SEO meta, structured data, and other important settings, it should always be the last tag before the closing head tag --}}
    {{ghost_head}}

</head>
<body class="{{body_class}} has-{{#match @custom.title_font "Elegant serif"}}serif{{else match @custom.title_font "Consistent mono"}}mono{{else}}sans{{/match}}-title has-{{#match @custom.body_font "Elegant serif"}}serif{{else}}sans{{/match}}-body">

<div class="gh-viewport">

    {{> "components/header" headerStyle="Highlight"}}

    {{{body}}}

    {{> "components/footer"}}

</div>

{{!-- カスタムPortalモーダル --}}
{{#if @site.members_enabled}}
    {{> "components/signup-form"}}
    {{> "components/signin-form"}}
{{/if}}

{{#is "post, page"}}
    {{> "lightbox"}}
{{/is}}

{{#if @member}}
  <script>
    window.currentMember = {
      uuid: "{{@member.uuid}}",
      name: "{{@member.name}}",
      email: "{{@member.email}}",
      paid: {{#if @member.paid}}true{{else}}false{{/if}}
    };

    window.ghostConfig = {
      contentApiKey: "{{content_api_key}}"
    };
  </script>
{{else}}
  <script>
    // ログイン後のリダイレクトやパラメータをチェック
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const hasLoginParams = urlParams.has('action') || urlParams.has('success') || urlParams.has('token');
      
      if (hasLoginParams) {
        console.log('Login parameters detected, reloading to refresh member state...');
        // パラメータを削除してリロード
        const cleanUrl = window.location.pathname;
        setTimeout(() => {
          window.location.replace(cleanUrl);
        }, 1000);
      }
    });
  </script>
{{/if}}

<script>
  window.ghostConfig = {
    contentApiKey: "{{content_api_key}}"
  };
</script>

{{!-- Scripts - handle responsive videos, infinite scroll, and navigation dropdowns --}}
<script src="{{asset "built/source.js"}}"></script>
<script src="{{asset "js/signup-form.js"}}"></script>
{{!-- <script src="{{asset "js/signin-form.js"}}"></script> --}}

{{!-- Portal制御スクリプト --}}
<script>
  // 最小限のsignin関数（競合を避けるため）
  function openSigninModal() {
    console.log('Opening signin modal (minimal)');
    const modal = document.getElementById('signin-modal');
    if (modal) {
      modal.showModal();
      document.body.classList.add('custom-portal-open');
    } else {
      console.log('Signin modal not found!');
    }
  }
  
  function closeSigninModal() {
    const modal = document.getElementById('signin-modal');
    if (modal) {
      modal.close();
      document.body.classList.remove('custom-portal-open');
    }
  }
  
  function switchToSignup() {
    console.log('Switching to signup from signin modal');
    
    // Signin modalを閉じる
    closeSigninModal();
    
    // 既存のGhost Portalがあれば閉じる
    const existingPortal = document.getElementById('ghost-portal-root');
    if (existingPortal) {
      console.log('Removing existing portal before showing signup');
      existingPortal.remove();
    }
    
    // カスタムPortalクラスをクリア
    document.body.classList.remove('custom-portal-open');
    
    setTimeout(() => {
      if (window.openSignupModal) {
        console.log('Opening custom signup modal');
        window.openSignupModal();
      }
    }, 200);
  }
  
  // グローバルに関数を登録
  window.openSigninModal = openSigninModal;
  window.closeSigninModal = closeSigninModal;
  window.switchToSignup = switchToSignup;

  document.addEventListener('DOMContentLoaded', function() {
    console.log('Portal control loaded');
    
    // Ghost Portal イベントリスナー
    window.addEventListener('message', function(event) {
      if (event.origin !== window.location.origin) return;
      
      if (event.data && event.data.type) {
        console.log('Portal event:', event.data.type, event.data);
      }
    });
    
    // クリックイベントの制御
    document.addEventListener('click', function(e) {
      const target = e.target.closest('[data-portal]');
      
      // Ghost Portal内のすべてのsigninリンクを無効化
      const signinLink = e.target.closest('a[href*="signin"], button[data-portal="signin"], .gh-portal-signin-switch, [onclick*="signin"]');
      if (signinLink && signinLink.closest('#ghost-portal-root')) {
        console.log('Portal signin link blocked:', signinLink);
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      if (target) {
        const portalType = target.getAttribute('data-portal');
        
        // signin処理：カスタムモーダルを使用（Ghost Portal外のみ）
        if (portalType === 'signin' && !target.closest('#ghost-portal-root')) {
          console.log('Custom signin button clicked');
          e.preventDefault();
          e.stopPropagation();
          openSigninModal();
          return false;
        }
        
        // signup処理：post-listなど特定のボタンのみカスタムモーダルを使用
        if (portalType === 'signup' && !target.closest('#ghost-portal-root') && 
            target.classList.contains('subscribe-button')) {
          console.log('Custom signup button clicked (from post-list or header)');
          e.preventDefault();
          e.stopPropagation();
          openSignupModal();
          return false;
        }
        
        // その他のPortal機能（account, upgrade等）はそのまま動作させる
      }
    });
  });
</script>

{{!-- Ghost outputs required functional scripts with this tag, it should always be the last thing before the closing body tag --}}
{{ghost_foot}}

</body>
</html>
